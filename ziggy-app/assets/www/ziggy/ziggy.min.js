/*! ziggy 2013-07-24 */
if("undefined"==typeof enketo||!enketo)var enketo={};if(enketo.hasValue=function(a){"use strict";return!("undefined"==typeof a||!a)},String.prototype.format||(String.prototype.format=function(){"use strict";var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})}),"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.IdFactory=function(a){"use strict";return{generateIdFor:function(b){return a.generateIdFor(b)}}},enketo.IdFactoryBridge=function(){"use strict";var a;return"undefined"!=typeof formDataRepositoryContext&&(a=formDataRepositoryContext),{generateIdFor:function(b){return a.generateIdFor(b)}}},"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.FormModelMapper=function(a,b,c){"use strict";var d=function(a,b,c){return enketo.hasValue(a)&&b.contains(a)&&!c.contains(a)},e=function(a,b,c,d){var e=a.to.split(".")[1],f=b.findEntityByTypeAndId(d);f.createField(f.source+"."+e,f.source+"."+e,e,c)},f=function(a,b){var c=a.form.fields.filter(function(a){return a.source===b.source})[0];enketo.hasValue(c)?enketo.hasValue(c.value)||(c.value=b.value):a.form.fields.push(b)},g=function(a,b){a.forEach(function(a){var c=i(a);f(b,c)})},h=function(a,b){var c=i(a);b.id=c.value},i=function(a){var b=a.getFieldByPersistenceName("id");return enketo.hasValue(b)?enketo.hasValue(b.value)||(b.value=c.generateIdFor(a.type)):(b={name:a.source+".id",source:a.source+".id",persistenceName:"id",value:c.generateIdFor(a.type)},a.addField(b)),b},j=function(a,b,c,f,g){d(a,b,c)&&(e(g,b,f,a),k(a,b,c))},k=function(b,c,e){var f=b.findParents();f.forEach(function(a){var b=c.findEntityByType(a.type);d(b,c,e)&&k(b,c,e)});var g;if(d(b,c,e)){var h={};b.forEachField(function(a){h[a.persistenceName]=a.value}),a.saveEntity(b.type,h),g=b.getFieldByPersistenceName("id").value,e.add(b)}var i=b.findChildren();i.forEach(function(a){if(a.kind===enketo.RelationKind.one_to_many.type){var b=c.findEntitiesByType(a.type);b.forEach(function(b){j(b,c,e,g,a)})}else{var d=c.findEntityByType(a.type);j(d,c,e,g,a)}})},l=function(a,b){for(var c=a,d=0;d<b.length;d++){var e=b[d];if(!enketo.hasValue(c[e])){c=void 0;break}c=c[e]}return c},m=function(a,b){return a.filter(function(a){return a.name===b?a:void 0})[0]},n=function(a,b){a.form.fields.forEach(function(a){if(a.shouldLoadValue){var c=a.source.split("."),d=l(b,c);enketo.hasValue(d)&&(a.value=d)}})},o=function(a,b,c){enketo.hasValue(a.form.sub_forms)&&a.form.sub_forms.forEach(function(d){var e=b.findPathToBaseEntityFromSubEntity(a.form.bind_type,d.bind_type),f=l(c,e);f.forEach(function(a){var b=null;d.fields.forEach(function(c){if(c.shouldLoadValue){var d=l(a,c.source.split(".").slice(-1));enketo.hasValue(d)&&(b=b||{},b[c.name]=d)}}),enketo.hasValue(b)&&d.instances.push(b)})})},p=function(a,b){if(enketo.hasValue(b)){var c=decodeURIComponent(decodeURIComponent(b)),d=JSON.parse(c);for(var e in d)if(d.hasOwnProperty(e)){var f=m(a.form.fields,e);enketo.hasValue(f)&&(f.value=d[e])}}},q=function(a,b){a.forEach(function(a){enketo.hasValue(a.source)||(a.source=b+"."+a.name)})},r=function(a){enketo.hasValue(a.form.sub_forms)&&a.form.sub_forms.forEach(function(a){q(a.fields,a.bind_type),a.instances=[]})};return{mapToFormModel:function(c,d,e){var f=JSON.parse(a.getFormInstanceByFormTypeAndId(e.id,e.formName));if(enketo.hasValue(f))return f;if(!enketo.hasValue(c))return d;if(q(d.form.fields,d.form.bind_type),r(d),!enketo.hasValue(e.entityId))return d;var g=b.loadEntityHierarchy(c,d.form.bind_type,e.entityId);return n(d,g),p(d,e.fieldOverrides),o(d,c,g),d},mapToEntityAndSave:function(a,b){var c=new enketo.Entities;b.form.fields.forEach(function(b){var d=b.source.split("."),e=d[d.length-2],f=c.findEntityByType(e);enketo.hasValue(f)||(f=a.findEntityDefinitionByType(e).createInstance(),f.source=b.source.substring(0,b.source.lastIndexOf(".")),c.add(f)),f.createField(b.name,b.source,d[d.length-1],b.value)});var d=new enketo.Entities;enketo.hasValue(b.form.sub_forms)&&b.form.sub_forms.forEach(function(b){b.instances.forEach(function(c){var e=a.findEntityDefinitionByType(b.bind_type).createInstance();b.fields.forEach(function(a){var b=a.source.split(".");e.createField(a.name,a.source,b[b.length-1],c[a.name])}),e.source=b.bind_type,h(e,c),d.add(e)})}),g(c,b),c.addAll(d);var e=new enketo.Entities,f=c.findEntityByType(b.form.bind_type);k(f,c,e)}}},"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.EntityRelationshipLoader=function(){"use strict";return{load:function(){return JSON.parse(ziggyFileLoader.loadAppData("entity_relationship.json"))}}},"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.Entity=function(a){"use strict";var b=this,c=function(a){return b.relations.filter(function(b){return b.as===a})};b.type=a,b.relations=[],b.fields=[],b.addField=function(a){return b.fields.push(a),b},b.createField=function(a,c,d,e){return b.fields.push({name:a,source:c,persistenceName:d,value:e}),b},b.findParents=function(){return c("child")},b.findChildren=function(){return c("parent")},b.getFieldByPersistenceName=function(a){return b.fields.filter(function(b){return b.persistenceName===a})[0]},b.forEachField=function(a){return b.fields.forEach(a)}},enketo.Relation=function(a,b,c,d,e){"use strict";var f=this;f.type=a,f.kind=b,f.as=c,f.from=d,f.to=e},"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.Entities=function(){"use strict";var a=this;a.entities=[],a.add=function(b){return a.entities.push(b),a},a.addAll=function(b){return a.entities=a.entities.concat(b.entities),a},a.forEach=function(b){return a.entities.forEach(b)},a.findEntityByType=function(b){for(var c=0;c<a.entities.length;c++)if(a.entities[c].type===b)return a.entities[c];return null},a.findEntityByTypeAndId=function(b){for(var c=0;c<a.entities.length;c++)if(a.entities[c].type===b.type&&a.entities[c].getFieldByPersistenceName("id").value===b.getFieldByPersistenceName("id").value)return a.entities[c];return null},a.findEntitiesByType=function(b){return a.entities.filter(function(a){return a.type===b})},a.contains=function(b){return enketo.hasValue(a.findEntityByTypeAndId(b))}},"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.EntityDef=function(a){"use strict";var b=this;b.type=a,b.relations=[],b.fields=[],b.addRelation=function(a){return b.relations.push(a),b},b.removeAllRelations=function(){b.relations=[]},b.createInstance=function(){var a=new enketo.Entity(b.type);return b.relations.forEach(function(b){a.relations.push(b.createInstance())}),a},b.findRelationByType=function(a){return b.relations.filter(function(b){return b.type===a})[0]}},enketo.RelationDef=function(a,b,c,d,e){"use strict";var f=this;f.type=a,f.kind=b,f.as=c,f.from=d,f.to=e,f.createInstance=function(){return new enketo.Relation(f.type,f.kind,f.as,f.from,f.to)}},"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.EntityDefinitions=function(){"use strict";var a=this;a.entityDefinitions=[],a.add=function(b){return a.entityDefinitions.push(b),a},a.findEntityDefinitionByType=function(b){for(var c=0;c<a.entityDefinitions.length;c++)if(a.entityDefinitions[c].type===b)return a.entityDefinitions[c];return null},a.hasEntityDefinitions=function(){return 0!==a.entityDefinitions.length},a.findPathToBaseEntityFromSubEntity=function(b,c){var d=a.findEntityDefinitionByType(c),e=d.findRelationByType(b);if(enketo.hasValue(e))return[e.type,c];for(var f=0;f<d.relations.length;f++){var g=a.findPathToBaseEntityFromSubEntity(b,d.relations[f].type);if(enketo.hasValue(g))return g.push(c),g}return null}},"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.RelationKind={one_to_one:{type:"one_to_one"},one_to_many:{type:"one_to_many"},many_to_one:{type:"many_to_one"}},enketo.RelationKind.one_to_one.inverse=enketo.RelationKind.one_to_one,enketo.RelationKind.one_to_many.inverse=enketo.RelationKind.many_to_one,enketo.RelationKind.many_to_one.inverse=enketo.RelationKind.one_to_many,"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.EntityRelationships=function(a){"use strict";var b=function(){var b=new enketo.EntityDefinitions;return a.forEach(function(a){var c=b.findEntityDefinitionByType(a.parent);enketo.hasValue(c)||b.add(new enketo.EntityDef(a.parent)),c=b.findEntityDefinitionByType(a.child),enketo.hasValue(c)||b.add(new enketo.EntityDef(a.child))}),b};return{determineEntitiesAndRelations:function(){if(!enketo.hasValue(a))return new enketo.EntityDefinitions;var c=b();return a.forEach(function(a){var b=c.findEntityDefinitionByType(a.parent);enketo.hasValue(b.relations)||b.removeAllRelations(),b.addRelation(new enketo.RelationDef(a.child,a.kind,"parent",a.from,a.to));var d=c.findEntityDefinitionByType(a.child);enketo.hasValue(d.relations)||d.removeAllRelations(),d.addRelation(new enketo.RelationDef(a.parent,enketo.RelationKind[a.kind].inverse.type,"child",a.to,a.from))}),c}}},"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.FormDefinitionLoader=function(){"use strict";return{load:function(a){return JSON.parse(ziggyFileLoader.loadAppData(a+"/form_definition.json"))}}},"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.SQLQueryBuilder=function(a){"use strict";var b=function(a,d,e,f){var g=a.findEntityDefinitionByType(f.type),h=f.from.split(".")[1],i="select * from {0} where {1} = '{2}'".format(f.type,f.to,d[h]),j=JSON.parse(c(f)(i));return enketo.hasValue(j)?enketo.hasValue(g.relations)&&0!==g.relations.length?(g.relations.forEach(function(c){if(c.type!==e){var d=b(a,j,g.type,c);enketo.hasValue(d)&&(j[c.type]=d)}}),j):j:null},c=function(b){return enketo.RelationKind[b.kind]===enketo.RelationKind.one_to_many?a.queryList:a.queryUniqueResult};return{loadEntityHierarchy:function(c,d,e){var f=c.findEntityDefinitionByType(d),g="select * from {0} where id = '{1}'".format(d,e),h=JSON.parse(a.queryUniqueResult(g));if(!enketo.hasValue(f.relations)||0===f.relations.length)return h;f.relations.forEach(function(a){h[a.type]=b(c,h,d,a)});var i={};return i[d]=h,i}}},"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.FormDataRepository=function(){"use strict";var a;return"undefined"!=typeof formDataRepositoryContext&&(a=formDataRepositoryContext),{getFormInstanceByFormTypeAndId:function(){return null},queryUniqueResult:function(b){return a.queryUniqueResult(b)},queryList:function(b){return a.queryList(b)},saveFormSubmission:function(b,c){return a.saveFormSubmission(JSON.stringify(b),JSON.stringify(c))},saveEntity:function(b,c){return a.saveEntity(b,JSON.stringify(c))}}},"undefined"==typeof enketo||!enketo)var enketo={};if(enketo.FormSubmissionRouter=function(){"use strict";var a;return"undefined"!=typeof formSubmissionRouter&&(a=formSubmissionRouter),{route:function(b){return a.route(b)}}},"undefined"==typeof enketo||!enketo)var enketo={};enketo.FormDataController=function(a,b,c,d,e){"use strict";var f=this,g=function(c){enketo.hasValue(f.entityRelationshipsJsonDefinition)||(f.entityRelationshipsJsonDefinition=a.load()),enketo.hasValue(f.entityDefinitions)||(f.entityDefinitions=enketo.EntityRelationships(f.entityRelationshipsJsonDefinition).determineEntitiesAndRelations()),enketo.hasValue(f.formDefinition)||(f.formDefinition=b.load(c.formName))};f.get=function(a){return g(a),c.mapToFormModel(f.entityDefinitions,f.formDefinition,a)},f.save=function(a,b){"object"!=typeof a&&(a=JSON.parse(a)),"object"!=typeof b&&(b=JSON.parse(b)),a=h(a,b),enketo.hasValue(d.saveFormSubmission(a,b))&&e.route(a.instanceId)},f.createOrUpdateEntity=function(a,b){"object"!=typeof a&&(a=JSON.parse(a)),"object"!=typeof b&&(b=JSON.parse(b)),a=h(a,b),e.route(a.instanceId)},f.deleteFormSubmission=function(a){g(a)};var h=function(a,b){if(g(a),f.entityDefinitions.hasEntityDefinitions()){c.mapToEntityAndSave(f.entityDefinitions,b);var d=b.form.fields.filter(function(a){return a.source===b.form.bind_type+".id"})[0];a.entityId=d.value}return a}};